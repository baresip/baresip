/**
 * @file fakevideo.c fakevideosource
 *
 * Copyright (C) 2019 Christoph Huber
 */


/*
How to from jpeg picture to a RTP-JPEG network package:

Installed packages of GStreamer:
gstreamer1.0-tools
gstreamer1.0-plugins-base
gstreamer1.0-plugins-good
gstreamer1.0-plugins-bad
gstreamer1.0-plugins-ugly

Sink:
gst-launch-1.0 udpsrc port=5200 !
  application/x-rtp,encoding-name=JPEG,payload=26 ! rtpjpegdepay ! jpegdec !
  autovideosink

Source;
gst-launch-1.0 -v multifilesrc location="<JPEG FILE>"
  caps="image/jpeg,framerate="1/1"" ! jpegdec ! jpegenc ! rtpjpegpay !
  udpsink host=127.0.0.1 port=5200

Get the network packages via Wireshark on the loopback interface.
Decode UDP packages as RTP.
Save the JPEG payload of the RTP package as raw data
Convert the raw data into c array via xxd
*/

#include <re.h>
#include <string.h>
#include <baresip.h>

#include "fakevideo.h"
#include "filter.h"
#include "rtspd.h"

#define DEBUG_MODULE "fakevideo"
#define DEBUG_LEVEL 6
#include <re_dbg.h>


struct onvif_fakevideo_stream {
	struct le le;

	bool active;                 /**< stream active flag           */
	struct rtp_sock *rtpsock;    /**< rtp socket struct for sending*/
	struct sa addr;              /**< address to send              */
	uint32_t timestamp;          /**< timestamp counter            */
};


static struct list fv_send_stream_list;
static mtx_t *fvmtx = NULL;


static unsigned char sample_jpeg_dat[] = {
  0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x10, 0x10, 0x00, 0x00, 0x00, 0x80,
  0x05, 0x03, 0x04, 0x04, 0x04, 0x03, 0x05, 0x04, 0x04, 0x04, 0x05, 0x05,
  0x05, 0x06, 0x07, 0x0c, 0x08, 0x07, 0x07, 0x07, 0x07, 0x0f, 0x0b, 0x0b,
  0x09, 0x0c, 0x11, 0x0f, 0x12, 0x12, 0x11, 0x0f, 0x11, 0x11, 0x13, 0x16,
  0x1c, 0x17, 0x13, 0x14, 0x1a, 0x15, 0x11, 0x11, 0x18, 0x21, 0x18, 0x1a,
  0x1d, 0x1d, 0x1f, 0x1f, 0x1f, 0x13, 0x17, 0x22, 0x24, 0x22, 0x1e, 0x24,
  0x1c, 0x1e, 0x1f, 0x1e, 0x05, 0x05, 0x05, 0x07, 0x06, 0x07, 0x0e, 0x08,
  0x08, 0x0e, 0x1e, 0x14, 0x11, 0x14, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e,
  0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e,
  0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e,
  0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e,
  0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0x1e, 0xfb, 0x2e, 0x8a, 0x28,
  0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28,
  0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28,
  0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28,
  0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28,
  0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28,
  0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28,
  0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0xa9, 0x58, 0xea, 0x36, 0x57, 0x97,
  0x37, 0x76, 0xd6, 0xb7, 0x31, 0x4b, 0x35, 0x9c, 0x82, 0x2b, 0x84, 0x56,
  0xc9, 0x8d, 0x8a, 0x86, 0x00, 0xfe, 0x06, 0xb0, 0x3e, 0x29, 0x78, 0xba,
  0xdb, 0xc1, 0x7e, 0x10, 0xba, 0xd6, 0x24, 0xda, 0xf7, 0x27, 0xf7, 0x56,
  0x91, 0x1f, 0xf9, 0x6b, 0x2b, 0x0f, 0x94, 0x7d, 0x07, 0x53, 0xec, 0xb5,
  0xf3, 0x2f, 0xc1, 0xcf, 0x88, 0x37, 0x5e, 0x1b, 0xf1, 0xfb, 0xea, 0x1a,
  0xad, 0xd3, 0x4b, 0x67, 0xaa, 0xc9, 0xb7, 0x52, 0x67, 0xe7, 0x92, 0x72,
  0x25, 0x3e, 0xe1, 0x8e, 0x7e, 0x9b, 0xab, 0xda, 0xcb, 0xf2, 0x4a, 0xb8,
  0xdc, 0x35, 0x4a, 0xf1, 0xfb, 0x3b, 0x79, 0xbf, 0xf8, 0x63, 0xc7, 0xc7,
  0x67, 0x14, 0xb0, 0x78, 0x88, 0x51, 0x97, 0xda, 0xdf, 0xcb, 0xb3, 0x3e,
  0xc6, 0xa2, 0x98, 0x8c, 0x1d, 0x43, 0xa3, 0x65, 0x4f, 0x20, 0x8e, 0x84,
  0x53, 0xeb, 0xc5, 0x3d, 0x80, 0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x8a, 0x28,
  0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x8a, 0xc7,
  0xf1, 0x8e, 0xb3, 0x17, 0x87, 0xbc, 0x2b, 0xa9, 0xeb, 0x72, 0xae, 0xf1,
  0x67, 0x6e, 0xf2, 0x85, 0x3f, 0xc6, 0xc0, 0x7c, 0xab, 0xf8, 0x9c, 0x0a,
  0x70, 0x83, 0x9c, 0xd4, 0x62, 0xae, 0xdd, 0x88, 0x9c, 0xd4, 0x20, 0xe4,
  0xf4, 0x48, 0xe5, 0xbe, 0x27, 0xfc, 0x53, 0xd0, 0xfc, 0x0c, 0x9f, 0x66,
  0x95, 0x1a, 0xff, 0x00, 0x55, 0x75, 0xdc, 0x96, 0x51, 0x30, 0x04, 0x03,
  0xd1, 0x9d, 0xb9, 0xda, 0x0f, 0xd3, 0x3e, 0xd5, 0xe2, 0xb7, 0xbf, 0xb4,
  0x27, 0x8d, 0x66, 0x9f, 0x7d, 0xad, 0x9e, 0x8f, 0x6d, 0x0e, 0xef, 0x95,
  0x3c, 0x96, 0x63, 0x8f, 0x72, 0x5b, 0x9f, 0xd2, 0xb9, 0x4f, 0x03, 0x68,
  0x1a, 0xaf, 0xc4, 0xcf, 0x88, 0x2d, 0x05, 0xd5, 0xdb, 0x99, 0x2e, 0x19,
  0xae, 0xaf, 0xee, 0x8f, 0x25, 0x10, 0x11, 0xb8, 0x81, 0xf5, 0x2a, 0xaa,
  0x2b, 0xea, 0x7f, 0x0e, 0xfc, 0x37, 0xf0, 0x4e, 0x87, 0x6b, 0x14, 0x36,
  0x9e, 0x1c, 0xd3, 0xa5, 0x78, 0xc8, 0x22, 0x7b, 0x88, 0x56, 0x69, 0x4b,
  0x0f, 0xe2, 0xdc, 0xc0, 0x90, 0x73, 0xe9, 0x5f, 0x65, 0x5a, 0x8e, 0x59,
  0x93, 0x41, 0x52, 0xad, 0x0f, 0x69, 0x51, 0xef, 0xfd, 0x74, 0x3e, 0x4a,
  0x95, 0x5c, 0xc7, 0x36, 0x72, 0x9d, 0x19, 0xfb, 0x3a, 0x6b, 0xfa, 0xf9,
  0x94, 0xe5, 0x5d, 0x47, 0x55, 0xf8, 0x4d, 0x71, 0x7b, 0xe2, 0xdd, 0x3f,
  0x4f, 0xfe, 0xd5, 0x3a, 0x64, 0xf3, 0x34, 0x49, 0x0f, 0x10, 0x93, 0x1b,
  0x15, 0x18, 0x72, 0xc4, 0x36, 0x31, 0x9f, 0x7a, 0xf9, 0xdb, 0xf6, 0x72,
  0xb6, 0xb6, 0xbb, 0xf8, 0xaf, 0xa7, 0x5b, 0xdd, 0x5b, 0xc5, 0x3c, 0x4d,
  0x14, 0xf9, 0x49, 0x14, 0x32, 0x9c, 0x46, 0xdd, 0x8d, 0x7d, 0x5b, 0xe3,
  0x4f, 0xf9, 0x13, 0xb5, 0xbf, 0xfb, 0x07, 0xcf, 0xff, 0x00, 0xa2, 0xda,
  0xbe, 0x57, 0xfd, 0x99, 0xff, 0x00, 0xe4, 0xaf, 0x69, 0xdf, 0xf5, 0xca,
  0x7f, 0xfd, 0x14, 0xd5, 0x19, 0x3d, 0x57, 0x2c, 0x06, 0x2e, 0x4b, 0x4d,
  0x1f, 0xcb, 0x46, 0x56, 0x6d, 0x05, 0x1c, 0x76, 0x16, 0x2f, 0x5d, 0xbf,
  0x35, 0xb9, 0xf5, 0xdc, 0x48, 0x91, 0x46, 0xb1, 0xc6, 0xaa, 0xa8, 0xa3,
  0x0a, 0xa3, 0x80, 0x00, 0xed, 0x52, 0x51, 0x45, 0x7c, 0x79, 0xf5, 0xc1,
  0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01,
  0x45, 0x14, 0x50, 0x01, 0x5c, 0x4f, 0xc7, 0x3b, 0x49, 0xaf, 0x7e, 0x12,
  0xf8, 0x86, 0x18, 0x06, 0x5c, 0x5b, 0x09, 0x4e, 0x3f, 0xba, 0x8e, 0xae,
  0xdf, 0xf8, 0xea, 0x9a, 0xed, 0xaa, 0x29, 0xa2, 0x8a, 0xe2, 0x07, 0x86,
  0x68, 0xd5, 0xe3, 0x91, 0x4a, 0xba, 0x9e, 0x41, 0x07, 0x82, 0x0d, 0x6b,
  0x87, 0xab, 0xec, 0x2a, 0xc6, 0xa6, 0xfc, 0xad, 0x3f, 0xb9, 0xdc, 0xc7,
  0x11, 0x4b, 0xda, 0xd2, 0x95, 0x3d, 0xb9, 0x93, 0x5f, 0x85, 0x8f, 0x97,
  0xbf, 0x64, 0xdd, 0x4e, 0xd6, 0xcf, 0xc7, 0x97, 0xb6, 0x13, 0xb2, 0xa4,
  0xd7, 0xf6, 0x65, 0x60, 0x2d, 0xdd, 0x95, 0x83, 0x15, 0x1f, 0x55, 0xc9,
  0xff, 0x00, 0x80, 0xd7, 0xd4, 0xd5, 0xf1, 0xe7, 0xc5, 0x7f, 0x87, 0x9a,
  0xcf, 0x80, 0x3c, 0x45, 0xfd, 0xa7, 0xa6, 0xfd, 0xa8, 0xe9, 0x3e, 0x6f,
  0x9b, 0x67, 0x79, 0x0e, 0x73, 0x6e, 0x73, 0x95, 0x46, 0x61, 0xf7, 0x58,
  0x76, 0x3d, 0xeb, 0x7f, 0x43, 0xfd, 0xa1, 0x7c, 0x57, 0x67, 0x62, 0x20,
  0xd4, 0x34, 0xdd, 0x3b, 0x52, 0x91, 0x57, 0x02, 0x73, 0xba, 0x26, 0x3e,
  0xec, 0x07, 0xca, 0x7f, 0x00, 0x2b, 0xec, 0xb3, 0x6c, 0xa6, 0x79, 0xa4,
  0xd6, 0x33, 0x07, 0x2e, 0x65, 0x24, 0xba, 0xff, 0x00, 0x5f, 0x34, 0x7c,
  0x96, 0x55, 0x99, 0xc3, 0x2c, 0x84, 0xb0, 0x98, 0xb8, 0xf2, 0xb8, 0xdf,
  0xa1, 0xef, 0x7f, 0x14, 0xb5, 0x5b, 0x5d, 0x1f, 0xe1, 0xe6, 0xbb, 0x7b,
  0x74, 0xea, 0x88, 0x6c, 0xa5, 0x89, 0x01, 0xfe, 0x37, 0x75, 0x2a, 0xaa,
  0x3e, 0xac, 0x6b, 0xe7, 0x2f, 0xd9, 0x6e, 0xce, 0x4b, 0x9f, 0x8a, 0x90,
  0xce, 0x8b, 0xf2, 0x5a, 0x59, 0xcd, 0x2c, 0x87, 0xd0, 0x11, 0xb0, 0x7e,
  0xaf, 0x58, 0x3e, 0x31, 0xf1, 0xa7, 0x8b, 0xfe, 0x24, 0xea, 0x96, 0xd6,
  0x53, 0xab, 0x4d, 0xf3, 0xff, 0x00, 0xa3, 0x69, 0xf6, 0x71, 0x9d, 0xbb,
  0x8f, 0x19, 0xdb, 0x92, 0x58, 0xe3, 0xb9, 0x35, 0xf4, 0x57, 0xc0, 0x8f,
  0x87, 0xc7, 0xc1, 0x1e, 0x1c, 0x96, 0x5b, 0xf2, 0xad, 0xac, 0x5f, 0x10,
  0xf7, 0x38, 0xe4, 0x44, 0xa3, 0xee, 0xc6, 0x0f, 0xb6, 0x79, 0x3e, 0xbf,
  0x4a, 0xce, 0x74, 0x56, 0x4d, 0x96, 0xd4, 0xa5, 0x52, 0x57, 0xa9, 0x53,
  0x4b, 0x7e, 0x1f, 0x81, 0x50, 0xac, 0xf3, 0x7c, 0xc6, 0x15, 0x69, 0x46,
  0xd4, 0xe9, 0xf5, 0xfc, 0x7f, 0x13, 0xd2, 0xa8, 0xa2, 0x8a, 0xf8, 0xc3,
  0xec, 0x42, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28,
  0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x08, 0xa6, 0x8a,
  0x39, 0xe1, 0x78, 0x66, 0x8d, 0x64, 0x8d, 0xc6, 0x19, 0x5d, 0x72, 0x18,
  0x1e, 0xc4, 0x1a, 0xe3, 0xb5, 0x0f, 0x85, 0x1f, 0x0f, 0x6f, 0x6e, 0x5a,
  0xe2, 0x6f, 0x0b, 0x59, 0xab, 0x9e, 0x4f, 0x92, 0xcf, 0x0a, 0xff, 0x00,
  0xdf, 0x28, 0x40, 0xfd, 0x2b, 0xb6, 0xa2, 0xb5, 0xa5, 0x88, 0xab, 0x43,
  0xf8, 0x72, 0x71, 0xbf, 0x66, 0xd7, 0xe4, 0x63, 0x57, 0x0f, 0x4a, 0xaf,
  0xf1, 0x22, 0xa5, 0x6e, 0xe9, 0x7e, 0xa6, 0x2f, 0x87, 0x3c, 0x2f, 0xe1,
  0xef, 0x0e, 0xc4, 0xc9, 0xa1, 0xe8, 0xf6, 0x76, 0x3b, 0xb8, 0x66, 0x86,
  0x30, 0x1d, 0x87, 0xbb, 0x7d, 0xe3, 0xf8, 0x9a, 0xda, 0xa2, 0x8a, 0xce,
  0x73, 0x9c, 0xdf, 0x34, 0x9d, 0xdb, 0xf3, 0x2e, 0x10, 0x84, 0x17, 0x2c,
  0x55, 0x92, 0xf2, 0x0a, 0x28, 0xa2, 0x91, 0x61, 0x45, 0x14, 0x50, 0x01,
  0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01,
  0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01,
  0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01,
  0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01,
  0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01,
  0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x07, 0xff, 0xd9 };
static unsigned int sample_jpeg_dat_len = 1246;
static struct tmr fakevideo_tmr;


static void onvif_fakevideo_stream_destructor(void *arg)
{
	struct onvif_fakevideo_stream *fvs = arg;

	list_unlink(&fvs->le);
	fvs->rtpsock = mem_deref(fvs->rtpsock);
	if (!list_count(&fv_send_stream_list))
		fvmtx = mem_deref(fvmtx);
}


static void fakevideo_tmr_h(void *arg)
{
	int err = 0;
	struct le *le;
	struct onvif_fakevideo_stream *fvs;
	struct mbuf *buf = NULL;

	(void)arg;

	err = mtx_lock(fvmtx);
	if (err)
		return;

	LIST_FOREACH(&fv_send_stream_list, le) {
		fvs = le->data;

		buf = mbuf_alloc(sample_jpeg_dat_len + RTP_HEADER_SIZE);
		if (!buf) {
			warning("%s: out f memory for fakevideo encoding",
				DEBUG_MODULE);
			err = ENOMEM;
			goto out;
		}

		mbuf_set_end(buf, buf->size);
		mbuf_advance(buf, RTP_HEADER_SIZE);
		memcpy(mbuf_buf(buf), sample_jpeg_dat, sample_jpeg_dat_len);
		err = rtp_send(fvs->rtpsock, &fvs->addr, false, false, 26,
			fvs->timestamp, tmr_jiffies_rt_usec(), buf);
		if (err) {
			warning("%s: Could noct send fake video via rtp. (%m)",
				DEBUG_MODULE, err);
			goto out;
		}

		fvs->timestamp ++;
		buf = mem_deref(buf);
	}

  out:
	mtx_unlock(fvmtx);
	mem_deref(buf);

	tmr_start(&fakevideo_tmr, (1000 / 1), fakevideo_tmr_h, NULL);
}


/**
 * init a fakevideo stream
 *
 * @param fvsp		fakevideostream struct pointer
 * @param codec		codec of the steam (MUST BE "JPEG")
 * @return int		0 if success, errorcode otherwise
 */
int onvif_fakevideo_alloc(struct onvif_fakevideo_stream **fvsp,
	const char *codec)
{
	int err = 0;
	struct onvif_fakevideo_stream *fvs = NULL;

	if (!fvsp || !codec)
		return EINVAL;

	if (strncmp(codec, "JPEG", 4))
		return EINVAL;

	fvs = mem_zalloc(sizeof(*fvs), onvif_fakevideo_stream_destructor);
	if (!fvs) {
		err = ENOMEM;
		goto out;
	}

	if (!fvmtx)
		err = mutex_alloc(&fvmtx);

	if (err)
		goto out;

	fvs->active = true;

  out:
	if (err)
		mem_deref(fvs);
	else
		*fvsp = fvs;

	return err;
}


/**
 * start fakevideo source
 *
 * @param fvs		fakevideo_stream struct
 * @param proto		transport protocol
 * @param tar		target
 * @param conn		rtsp connection struct
 * @return int		0 if success, errorcode otherwise
 */
int onvif_fakevideo_start(struct onvif_fakevideo_stream *fvs, int proto,
	const struct sa *tar, const struct rtsp_conn *conn)
{
	int err = 0;

	if (!fvs || !tar)
		return EINVAL;

	mtx_lock(fvmtx);
	sa_cpy(&fvs->addr, tar);

	switch (proto) {
		case IPPROTO_TCP:
			if (!conn) {
				err = EINVAL;
				goto out;
			}

			err = rtp_over_tcp(&fvs->rtpsock, &fvs->addr,
				mem_ref((struct rtsp_conn *) conn));
			if (err)
				goto out;
			break;

		case IPPROTO_UDP:
			err = rtp_open(&fvs->rtpsock, sa_af(&fvs->addr));
			if (err)
				goto out;
			break;

		default:
			err = ENOTSUP;
			goto out;
	}

	list_append(&fv_send_stream_list, &fvs->le, fvs);
	if (!tmr_isrunning(&fakevideo_tmr)) {
		tmr_init(&fakevideo_tmr);
		tmr_start(&fakevideo_tmr, (1000 / 1), fakevideo_tmr_h, NULL);
	}

  out:
	mtx_unlock(fvmtx);
	return err;
}


/**
 * stop the fakevideo source
 *
 * @param fvs	fakevideo_stream struct
 */
void onvif_fakevideo_stop(struct onvif_fakevideo_stream *fvs)
{
	mtx_lock(fvmtx);
	mem_deref(fvs);
	mtx_unlock(fvmtx);

	if (list_isempty(&fv_send_stream_list))
		tmr_cancel(&fakevideo_tmr);
}
