name: PR Checks

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  CONAN_NON_INTERACTIVE: 1

jobs:
  # Core validation - these jobs will show as required status checks
  validate:
    name: "✅ Validate"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install tools
      run: |
        pip install conan yamllint
        
    - name: Validate Conan recipe
      run: |
        conan export . --name=baresip --version=4.0.0
        
    - name: Check workflow syntax
      run: |
        yamllint .github/workflows/
        
  # Quick build test
  quick-build:
    name: "🚀 Quick Build"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Conan
      run: |
        pip install "conan>=2.0.0"
        
    - name: Configure Conan
      run: |
        conan profile detect --force
        
    - name: Install system deps (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake pkg-config
        
    - name: Cache Conan packages
      uses: actions/cache@v3
      with:
        path: ~/.conan2
        key: pr-${{ matrix.os }}-${{ hashFiles('conanfile.py') }}
        restore-keys: |
          pr-${{ matrix.os }}-
          conan-quick-${{ matrix.os }}-
          conan-
          
    - name: Quick build test
      run: |
        # Minimal build for fast PR feedback
        conan create . \
          -o with_ffmpeg=False \
          -o with_opus=True \
          -o with_vpx=False \
          -o with_av1=False \
          -o with_sdl=True \
          -o with_gstreamer=False \
          --build=missing
          
    - name: Verify package
      run: |
        conan list baresip/4.0.0:*
        
  # Summary for PR
  pr-summary:
    name: "📋 PR Summary"
    runs-on: ubuntu-latest
    needs: [validate, quick-build]
    if: always()
    
    steps:
    - name: Generate PR summary
      run: |
        echo "## 🎯 PR Check Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.validate.result }}" == "success" ]]; then
          echo "- ✅ **Recipe Validation**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ **Recipe Validation**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.quick-build.result }}" == "success" ]]; then
          echo "- ✅ **Quick Build**: Passed on Linux & macOS" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ **Quick Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔄 Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Merge when all checks pass" >> $GITHUB_STEP_SUMMARY
        echo "- Full CI will run on merge to main" >> $GITHUB_STEP_SUMMARY
        echo "- Multi-platform testing available in other workflows" >> $GITHUB_STEP_SUMMARY